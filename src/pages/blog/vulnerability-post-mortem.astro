---
import Base from "../../layouts/Base.astro";
const title = "Vulnerability post-mortem: July 2023";
const description =
  "A recap of the H2 Unauthenticated Remote Code Execution vulnerability and our response.";
const seo = {
  title: "Vulnerability post-mortem: July 2023",
  description:
    "A recap of the H2 Unauthenticated Remote Code Execution vulnerability and our response.",
  canonical: "/blog/vulnerability-post-mortem",
  og: {
    title: "Vulnerability post-mortem: July 2023",
    description:
      "A recap of the H2 Unauthenticated Remote Code Execution vulnerability and our response.",
    image:
      "https://www.metabase.com/images/posts/vulnerability-post-mortem-2023-08-04/what-happened.png",
    url: "https://www.metabase.com/blog/vulnerability-post-mortem",
    type: "article",
    site_name:
      "Metabase | Open source Business Intelligence and Embedded Analytics",
  },
  twitter: {
    site: "@metabase",
    title: "Vulnerability post-mortem: July 2023",
    description:
      "A recap of the H2 Unauthenticated Remote Code Execution vulnerability and our response.",
    card: "summary_large_image",
    image:
      "https://www.metabase.com/images/posts/vulnerability-post-mortem-2023-08-04/what-happened.png",
    creator: "The Metabase Team",
  },
};
---

<Base {title} {description} {seo}>
  <div class="MB-Page page-content">
    <div class="progress-bar z1" id="progress-bar"></div>

    <div class="bootstrap">
      <div id="post" class="bg-neutral-98-gradient">
        <div class="container pt-4">
          <section>
            <div
              class="row d-flex flex-column flex-lg-row align-items-start mb-11 mb-lg-13"
            >
              <div class="col-xs-12 col-lg-3">
                <a
                  class="chevron blue-small-left mb-8 mb-lg-0 fw-bold"
                  href="/blog">All posts</a
                >
              </div>
              <div class="col-xs-12 col-lg-9">
                <div class="d-lg-none mb-4 d-flex flex-column flex-sm-row">
                  <span class="paragraph-5 neutral-60 me-2"
                    >Aug 04, 2023 in <b class="category-name">News</b></span
                  >

                  <p class="paragraph-5 neutral-60 mb-0 d-none d-sm-block me-2">
                    ‧
                  </p>
                  <p class="paragraph-5 neutral-60 mb-0">17 min read</p>
                </div>
                <h1 class="h2 mb-6 mb-lg-8">
                  Vulnerability post-mortem: July 2023
                </h1>
                <div class="d-flex flex-row align-items-center">
                  <img
                    class="circle me-2"
                    src="/images/posts/blog-authors/the-metabase-team.svg"
                    alt="The Metabase Team Portrait"
                    width="36"
                    height="36"
                  />
                  <h5 class="neutral-40 mb-0 me-2">The Metabase Team</h5>
                  <div class="d-none d-lg-flex flex-row">
                    <span class="paragraph-5 neutral-60 me-2">
                      ‧ Aug 04, 2023 in <b class="category-name">News</b></span
                    >

                    <p class="paragraph-5 neutral-60 mb-0">‧ 17 min read</p>
                  </div>
                </div>
              </div>
            </div>

            <img
              src="/images/posts/vulnerability-post-mortem-2023-08-04/what-happened.png"
              alt="Vulnerability post-mortem: July 2023 Image"
              class="w-100 rounded-4"
              loading="lazy"
            />
          </section>
          <section class="row d-flex">
            <div class="col-xs-12 col-lg-3 order-1 order-lg-0 mt-11 mt-lg-0">
              <div
                style="position: sticky; top: 136px;"
                class="d-flex flex-column"
              >
                <h5 class="mb-3 neutral-40">Share this article</h5>
                <div class="d-flex align-items-center gap-3">
                  <a
                    href="https://twitter.com/intent/tweet?url=https://metabase.com/blog/vulnerability-post-mortem"
                    target="popup"
                    onclick="window.open('https://twitter.com/intent/tweet?url=https://metabase.com/blog/vulnerability-post-mortem','popup','width=600,height=600,scrollbars=no,resizable=no'); return false;"
                  >
                    <svg
                      id=""
                      class="share-button"
                      width="22"
                      height="22"
                      viewBox="0 0 26 22"
                      fill="#C6C9D2"
                    >
                      <path
                        d="M24.9465693,3.43255605 C24.0654891,3.83264574 23.1186277,4.10304933 22.1248175,4.22466368 C23.1392117,3.60206278 23.9181606,2.61623318 24.2849927,1.44161435 C23.3357664,2.01802691 22.2843212,2.43668161 21.1652555,2.66233184 C20.2690219,1.68466368 18.9922044,1.07372197 17.5791825,1.07372197 C14.8658686,1.07372197 12.6661022,3.32600897 12.6661022,6.10403587 C12.6661022,6.49829596 12.709635,6.88224215 12.7933723,7.25040359 C8.71021898,7.0406278 5.09016058,5.03793722 2.6670365,1.99452915 C2.24414599,2.73748879 2.00186861,3.60161435 2.00186861,4.52349776 C2.00186861,6.26869955 2.86928467,7.80843049 4.18753285,8.71049327 C3.38213139,8.68439462 2.62464234,8.45811659 1.96218978,8.08134529 C1.96183942,8.10233184 1.96183942,8.12340807 1.96183942,8.14457399 C1.96183942,10.5818834 3.65532847,12.6150673 5.90283212,13.07713 C5.49054015,13.1921076 5.05652555,13.2535426 4.60840876,13.2535426 C4.29185401,13.2535426 3.98405839,13.2220628 3.68414599,13.1633184 C4.30928467,15.1618834 6.12364964,16.6162332 8.27348905,16.656861 C6.59208759,18.006009 4.47369343,18.8102242 2.1719708,18.8102242 C1.77544526,18.8102242 1.38435036,18.7864574 1,18.74 C3.17418978,20.1672646 5.75664234,21 8.53109489,21 C17.567708,21 22.5092555,13.3347982 22.5092555,6.68735426 C22.5092555,6.46923767 22.5045255,6.252287 22.4950657,6.03659193 C23.4548905,5.32735426 24.2878832,4.44134529 24.9465693,3.43255605"
                      >
                      </path>
                    </svg>
                  </a>
                  <a
                    href="https://www.linkedin.com/sharing/share-offsite/?url=https://metabase.com/blog/vulnerability-post-mortem"
                    target="popup"
                    onclick="window.open('https://www.linkedin.com/sharing/share-offsite/?url=https://metabase.com/blog/vulnerability-post-mortem','popup','width=600,height=600,scrollbars=no,resizable=no'); return false;"
                  >
                    <svg
                      id=""
                      class="share-button"
                      fill="#C6C9D2"
                      xmlns="http://www.w3.org/2000/svg"
                      viewBox="0 0 30 30"
                      width="30"
                      height="30"
                    >
                      <path
                        d="M24,4H6C4.895,4,4,4.895,4,6v18c0,1.105,0.895,2,2,2h18c1.105,0,2-0.895,2-2V6C26,4.895,25.105,4,24,4z M10.954,22h-2.95 v-9.492h2.95V22z M9.449,11.151c-0.951,0-1.72-0.771-1.72-1.72c0-0.949,0.77-1.719,1.72-1.719c0.948,0,1.719,0.771,1.719,1.719 C11.168,10.38,10.397,11.151,9.449,11.151z M22.004,22h-2.948v-4.616c0-1.101-0.02-2.517-1.533-2.517 c-1.535,0-1.771,1.199-1.771,2.437V22h-2.948v-9.492h2.83v1.297h0.04c0.394-0.746,1.356-1.533,2.791-1.533 c2.987,0,3.539,1.966,3.539,4.522V22z"
                      ></path>
                    </svg>
                  </a>
                  <a
                    class="copy-clip position-relative d-flex justify-content-center"
                    title="Copy to clipboard"
                  >
                    <svg
                      id=""
                      class="share-button"
                      width="32"
                      height="32"
                      viewBox="0 0 32 32"
                      fill="#C6C9D2"
                      xmlns="http://www.w3.org/2000/svg"
                    >
                      <path
                        fill-rule="evenodd"
                        clip-rule="evenodd"
                        d="M19.2939 9.17106C19.5246 8.93228 19.8004 8.74183 20.1054 8.61081C20.4104 8.47978 20.7385 8.41082 21.0704 8.40793C21.4024 8.40505 21.7316 8.4683 22.0388 8.59401C22.3461 8.71971 22.6252 8.90534 22.8599 9.14007C23.0947 9.3748 23.2803 9.65393 23.406 9.96117C23.5317 10.2684 23.595 10.5976 23.5921 10.9296C23.5892 11.2615 23.5202 11.5896 23.3892 11.8946C23.2582 12.1996 23.0677 12.4754 22.8289 12.7061L19.0789 16.4561C18.6101 16.9247 17.9744 17.188 17.3114 17.188C16.6485 17.188 16.0128 16.9247 15.5439 16.4561C15.3082 16.2284 14.9924 16.1024 14.6647 16.1052C14.3369 16.1081 14.0234 16.2395 13.7917 16.4713C13.5599 16.703 13.4284 17.0166 13.4256 17.3443C13.4228 17.6721 13.5487 17.9878 13.7764 18.2236C14.7141 19.1609 15.9856 19.6875 17.3114 19.6875C18.6373 19.6875 19.9088 19.1609 20.8464 18.2236L24.5964 14.4736C25.5072 13.5305 26.0112 12.2675 25.9998 10.9566C25.9884 9.64557 25.4626 8.39151 24.5355 7.46447C23.6085 6.53743 22.3544 6.01158 21.0434 6.00019C19.7325 5.9888 18.4695 6.49277 17.5264 7.40356L15.6514 9.27856C15.5321 9.39387 15.4368 9.5318 15.3713 9.6843C15.3058 9.83681 15.2713 10.0008 15.2699 10.1668C15.2684 10.3328 15.3001 10.4974 15.3629 10.651C15.4258 10.8046 15.5186 10.9442 15.6359 11.0616C15.7533 11.1789 15.8929 11.2717 16.0465 11.3346C16.2001 11.3974 16.3647 11.4291 16.5307 11.4276C16.6967 11.4262 16.8607 11.3917 17.0132 11.3262C17.1657 11.2607 17.3036 11.1654 17.4189 11.0461L19.2939 9.17106ZM13.0439 15.4211C13.5128 14.9524 14.1485 14.6891 14.8114 14.6891C15.4744 14.6891 16.1101 14.9524 16.5789 15.4211C16.6942 15.5404 16.8322 15.6357 16.9847 15.7012C17.1372 15.7667 17.3012 15.8012 17.4672 15.8026C17.6332 15.8041 17.7978 15.7724 17.9514 15.7096C18.105 15.6467 18.2446 15.5539 18.3619 15.4366C18.4793 15.3192 18.5721 15.1796 18.635 15.026C18.6978 14.8724 18.7294 14.7078 18.728 14.5418C18.7266 14.3758 18.6921 14.2118 18.6266 14.0593C18.5611 13.9068 18.4658 13.7689 18.3464 13.6536C17.4088 12.7162 16.1373 12.1896 14.8114 12.1896C13.4856 12.1896 12.2141 12.7162 11.2764 13.6536L7.52644 17.4036C7.04889 17.8648 6.66798 18.4165 6.40593 19.0265C6.14389 19.6366 6.00596 20.2927 6.00019 20.9566C5.99442 21.6205 6.12093 22.2788 6.37233 22.8933C6.62374 23.5078 6.995 24.0661 7.46447 24.5355C7.93393 25.005 8.49219 25.3763 9.10667 25.6277C9.72115 25.8791 10.3796 26.0056 11.0434 25.9998C11.7073 25.994 12.3634 25.8561 12.9735 25.5941C13.5835 25.332 14.1352 24.9511 14.5964 24.4736L16.4714 22.5986C16.5908 22.4833 16.6861 22.3453 16.7516 22.1928C16.8171 22.0403 16.8516 21.8763 16.853 21.7103C16.8544 21.5443 16.8228 21.3797 16.76 21.2261C16.6971 21.0725 16.6043 20.9329 16.4869 20.8156C16.3696 20.6982 16.23 20.6054 16.0764 20.5425C15.9228 20.4797 15.7582 20.4481 15.5922 20.4495C15.4262 20.4509 15.2622 20.4854 15.1097 20.5509C14.9572 20.6164 14.8192 20.7117 14.7039 20.8311L12.8289 22.7061C12.5983 22.9448 12.3225 23.1353 12.0175 23.2663C11.7124 23.3973 11.3844 23.4663 11.0524 23.4692C10.7205 23.4721 10.3913 23.4088 10.0841 23.2831C9.77682 23.1574 9.49769 22.9718 9.26295 22.737C9.02822 22.5023 8.84259 22.2232 8.71689 21.9159C8.59118 21.6087 8.52793 21.2795 8.53082 20.9476C8.5337 20.6156 8.60267 20.2876 8.73369 19.9825C8.86471 19.6775 9.05517 19.4017 9.29394 19.1711L13.0439 15.4211Z"
                      ></path>
                    </svg>

                    <div class="copied-to-clipboard-wrapper visible invisible">
                      <div class="caret"></div>
                      <div class="copied-to-clipboard">Copied to clipboard</div>
                    </div>
                  </a>
                </div>
              </div>
            </div>
            <div
              class="content-container col-xs-12 col-lg-6 order-0 order-lg-1"
            >
              <div id="post-content">
                <p>
                  Over the last two weeks, Metabase has had the worst
                  vulnerability in the history of the project. We know this
                  vulnerability has been extremely disruptive to you, our
                  community, and are especially sorry to have had to announce
                  two successive calls to upgrade on a Friday.
                </p>

                <p>
                  Now that the dust has mostly settled, we wanted to lay out
                  what happened and why we did what we did. We know that a call
                  to “UPGRADE NOW” without any explanation was opaque and
                  required our community to have a lot of faith in our
                  judgement. We hope that by being transparent about what
                  happened (both good and bad), the community will continue to
                  trust us in the future.
                </p>

                <p>
                  At the center of the story is a rather nasty cluster of
                  vulnerabilities, and to best understand the events in the
                  timeline, it’s useful to understand the actual vulnerabilities
                  at play.
                </p>

                <p>
                  Just a heads up—this is a rather long and fairly technical
                  post targeted towards those administering and securing
                  Metabase.
                </p>

                <h2 id="what-happened">What happened</h2>

                <h3 id="the-vulnerability">The vulnerability</h3>

                <p>
                  The heart of this cluster of vulnerabilities was a database we
                  supported–H2. H2 is a JVM-based embedded database. We used H2
                  as a “batteries-included” database for Metabase to store user
                  accounts, dashboard definitions, settings, etc. When we were
                  evaluating ways to ship sample data, it became the winner
                  there as well. As part of using H2 to ship our Sample
                  Database, we decided to also let people connect any H2
                  databases they might have lying around as well. It was never
                  widely used, but it “came for free”, and so we largely left H2
                  as a supported option.
                </p>

                <p>
                  Because H2 is, practically speaking, mostly used for embedding
                  inside other applications, it has a large number of features
                  that were not designed for multiple clients in mind. More
                  specifically, there are ways to get H2 to run interpreters
                  in-process, there are connection string arguments that allow
                  you to run SQL (or anything else), and there is generally a
                  lack of hardening towards malicious clients. We previously
                  found and fixed one way of doing this (via <code
                    class="language-plaintext highlighter-rouge">INIT</code
                  > parameters on the connection string), but the most recent vulnerability
                  (or really a cluster of three different vulnerabilities) stemmed
                  from this.
                </p>

                <p>There were three distinct issues at play:</p>

                <ol>
                  <li>
                    You could use unicode (e.g., an ï instead of an I) to get
                    past our checks for the <code
                      class="language-plaintext highlighter-rouge">INIT</code
                    > keyword, as H2 will convert them under the hood (hat tip <a
                      href="https://www.ubercomp.com/">Reginaldo Silva</a
                    >).
                  </li>
                  <li>
                    You could trick Metabase into treating the database
                    connection as a PostgreSQL connection, but have the JDBC <code
                      class="language-plaintext highlighter-rouge"
                      >DriverManager</code
                    > load the H2 driver instead by sneaking in an H2 connection
                    string in the details payload (hat tip Chaitin Security Response
                    Institute and bluE0).
                  </li>
                  <li>
                    The <code class="language-plaintext highlighter-rouge"
                      >TRACE_LEVEL_SYSTEM_OUT</code
                    > option in H2 is vulnerable to SQL injection (hat tip AssetNote
                    and Maxwell Garrett).
                  </li>
                </ol>

                <p>
                  So far, these issues make up a very annoying set of
                  vulnerabilities that would allow someone who adds or validates
                  a new database connection to break into the host OS running
                  Metabase. Normally, host OS access is limited to Metabase
                  admins, so while it <em>is</em> a problem to be sure, it’s not
                  a stop-the-world event.
                </p>

                <p>But there were two other key pieces to the puzzle.</p>

                <p>
                  First, people will often get connection strings wrong, and
                  it’s common to do a test connection before confirming
                  someone’s entry of a connection string. We offered an API call
                  to facilitate this check before saving a database connection.
                  In the usual admin panel flow for adding database, this was
                  protected by an API check for admin privileges.
                </p>

                <p>
                  The final and most embarrassing piece of the puzzle: we have a
                  setup process that creates a user account <em>and</em> connects
                  a database in one API call. We combined these two actions in single
                  step and exposed an unauthenticated API endpoint <code
                    class="language-plaintext highlighter-rouge"
                    >/api/setup/validate</code
                  > which would try to connect to a database connection string. This
                  endpoint was only accessible if used with a <code
                    class="language-plaintext highlighter-rouge"
                    >setup_token</code
                  >. This <code class="language-plaintext highlighter-rouge"
                    >setup_token</code
                  > was never meant to be publicly exposed, and normally Metabase
                  would delete the token immediately after first usage. Early last
                  year, however, we made some changes to allow the token to be injected
                  via an environment variable, and inadvertently leaked the token
                  into the settings exposed in <code
                    class="language-plaintext highlighter-rouge"
                    >/api/session/properties</code
                  > (in addition to not properly clearing the token after first use).
                </p>

                <p>
                  These pieces, combined with the ability to get H2 to execute
                  commands in the host OS, resulted in an unauthenticated Remote
                  Code Execution, and ruined two successive Fridays for the
                  Metabase community.
                </p>

                <p>Putting all of these together, one could:</p>

                <ol>
                  <li>
                    Call <code class="language-plaintext highlighter-rouge"
                      >/api/session/properties</code
                    > to get the setup token.
                  </li>
                  <li>
                    Use the setup token to call <code
                      class="language-plaintext highlighter-rouge"
                      >/api/setup/validate</code
                    >.
                  </li>
                  <li>
                    Take advantage of the missing checks to get H2 to execute
                    commands on the host operating system.
                  </li>
                  <li>Open a reverse shell, create admin accounts, etc.</li>
                </ol>

                <p>In short, this was an extremely serious attack chain.</p>

                <h3 id="initial-report-and-fix-july-13-21st">
                  Initial report and fix (July 13-21st)
                </h3>

                <p>
                  On <strong>July 13th</strong> we received a report from an external
                  researcher about a security vulnerability in the application. The
                  report detailed the above (very easy) path to run custom code in
                  the Metabase server without any need for authentication (we’ll
                  call this initial vulnerability the “AssetNote” vulnerability,
                  as the Assetnote team reported it).
                </p>

                <p>
                  By <strong>July 14th</strong>, we wrote, tested, and built a
                  fix for this vulnerability. We pushed it to the 2000+ servers
                  we host on behalf of our Metabase Cloud customers.
                </p>

                <p>
                  However, at this point we had a bit of a problem with what to
                  do next. We have hundreds of self-hosted customers who we had
                  a contractual and moral responsibility to keep protected. We
                  also have a community of 50,000+ organizations running
                  Metabase on their servers. Abusing the vulnerability is
                  trivial once you know it’s there, and while the vulnerability
                  requires some specific skills to access the underlying data
                  warehouse using it, abuse for DDoS, spam, and crypto mining
                  require almost no skill or effort. We also have no way of
                  forcing anyone to upgrade, or even a way to send email to
                  those running Metabase servers.
                </p>

                <p>
                  The standard option would be to issue a patch, let the world
                  know about the patch, and let anyone not paying us to manage
                  their servers fend for themselves. If this vulnerability was a
                  run-of-the-mill issue that didn’t allow anyone anywhere in the
                  world to access user data on any Metabase instance, we would
                  have done just that.
                </p>

                <p>
                  We really wanted to do better than that. After some thought,
                  we ended up with a three-phase plan.
                </p>

                <ol>
                  <li>
                    Give our paying customers the patched binaries. We would
                    offer those customers running custom forks the actual source
                    patch under NDA.
                  </li>
                  <li>
                    After one week, publicly release a fix without the source
                    code. Inform our community that it was an unauthenticated
                    RCE (Remote Code Execution), and that it was imperative to
                    upgrade immediately.
                  </li>
                  <li>
                    After an additional week, merge the fix into our main,
                    public repository, and publish a CVE, attributing everyone
                    who helped us find and fix this.
                  </li>
                </ol>

                <p>
                  In this plan, we were making a very specific tradeoff. We knew
                  that a Clojure JAR can be decompiled and the decompiled JVM
                  source code examined (Clojure specifically often includes
                  source in the jar). We stripped our patched binaries of this
                  source code as well. Throughout this release process, we knew
                  that it was impossible to provide a fix without letting a
                  sophisticated researcher or attacker know what the bug was and
                  how to exploit it. <strong
                    >But we were hoping that we could buy our install base as
                    many days to upgrade as possible before the exploit entered
                    general circulation.</strong>
                </p>

                <h3 id="hurry-up-and-wait-july-18-21st">
                  Hurry up and wait (July 18-21st)
                </h3>

                <p>
                  <strong>On July 18th</strong>, we had patched and stripped
                  binaries in place and announced to our self-hosted customers.
                </p>

                <p>This initial patch:</p>

                <ul>
                  <li>
                    Completely blocked the vulnerable endpoint from being used
                    if you already initialized the instance (a.k.a. completed
                    the setup flow).
                  </li>
                  <li>
                    Detected some strings that were passed to the connection
                    string of the database that made this first attack possible
                    on both the <code
                      class="language-plaintext highlighter-rouge"
                      >/api/setup/validate</code
                    > endpoint (public, you don’t need authentication for it) and
                    the <code class="language-plaintext highlighter-rouge"
                      >/api/database</code
                    > (private, you need authentication). If found, these would return
                    an error rather than passing them into H2.
                  </li>
                </ul>

                <p>
                  We shared patched binaries of all versions affected with these
                  customers, but held back the source. For customers with a
                  custom fork, we asked that they reach out to us directly, and
                  we gave them the patch under NDA. Approximately twenty
                  customers were running custom forks and reached out to us.
                </p>

                <p>So far so good.</p>

                <p>
                  Over the next three days, some events happened that changed
                  our plans.
                </p>

                <h3 id="wait-and-watch-july-21-27th">
                  Wait and watch (July 21-27th)
                </h3>

                <p>
                  We received seemingly two independent reports from customers
                  stating that they already knew of the vulnerability. At the
                  time, it was very surprising, as the vulnerability had been
                  present for over a year before it was found, and exploitation
                  required fairly specific usage of a number of gaps in our
                  product. We dug in a bit deeper and learned that both
                  customers had been informed by the original research team that
                  had discovered the vulnerability (both customers offer a bug
                  bounty on Metabase security issues).
                </p>

                <p>
                  This, combined with the number of custom forks, made us very
                  concerned about leaving our OSS community without advance
                  warning or viable fixed binaries. So we decided to accelerate
                  our announcement timeline, but still hold back on disclosing
                  the actual exploit.
                </p>

                <p>
                  <strong>On July 21th</strong>, <a
                    href="https://twitter.com/metabase/status/1682341968888713216"
                    >we tweeted</a
                  >, <a href="/blog/vulnerability-advisory">updated our blog</a
                  >, <a
                    href="https://www.linkedin.com/posts/metabase_please-upgrade-your-metabase-immediately-activity-7088107650608979968-ni7y?utm_source=share&utm_medium=member_desktop"
                    >posted on LinkedIn</a
                  >, and sent an email to our entire Updates mailing list that
                  several tens of thousands of people had signed up for.
                </p>

                <p>
                  We started monitoring social media to see if something came
                  up, but there was nothing relevant for days, including on
                  Hacker News. For a number of days, there was bit of interest,
                  but no news of anyone decompiling and recreating the exploit.
                </p>

                <p>
                  <strong>On July 26th</strong>, we received another security
                  report (the “Qing” vulnerability from now on), which detailed
                  how to bypass the controls on the <code
                    class="language-plaintext highlighter-rouge"
                    >/api/database</code
                  > endpoint (which is restricted to authenticated admins) by using
                  a separate key in the connection details (not all in the same connection
                  string), and also a variation of the AssetNote vulnerability which
                  used a connection to an external database to run the commands.
                </p>

                <p>
                  While troubling, these discoveries required a logged-in admin,
                  and so long as the previous patched binaries were deployed,
                  there was no unauthenticated RCE possible.
                </p>

                <p>
                  <strong>On July 27th</strong>, an engineer (“Reginaldo” from
                  now on) managed to reverse engineer our patch and discovered a
                  new attack on the public <code
                    class="language-plaintext highlighter-rouge"
                    >/api/setup/validate</code
                  > endpoint. This attack which used a diacritic character (glyph
                  added to a letter) to bypass some controls we had in place, but
                  the vulnerability only affected non-initialized instances (instances
                  that were in setup mode), and another vulnerability that also affects
                  the <code class="language-plaintext highlighter-rouge"
                    >/api/database</code
                  > (private) endpoint, which opens the H2 server as an external
                  database which you can run commands on.
                </p>

                <p>
                  This raised the stakes a bit, as there was now an
                  unauthenticated RCE possible against a patched instance–though
                  for only a few minutes when an instance is first being set up.
                </p>

                <h3 id="rush-to-a-public-release-july-28-31st">
                  Rush to a public release (July 28-31st)
                </h3>

                <p>
                  Later that day (overnight in US timezones), a fourth group of
                  security researchers published a blog post without prior
                  contact with us. This post included details about the
                  “AssetNote” vulnerability, which led AssetNote to publish
                  their findings (as the cat was out of the bag).
                </p>

                <p>
                  Waking up to it <strong>On July 28th,</strong> we saw that this
                  post included <em>another</em>, “hidden” attack that the
                  authors “left for the reader to discover”. We contacted them,
                  and they let us know about a previously unknown means of
                  getting to H2 via the JDBC <code
                    class="language-plaintext highlighter-rouge"
                    >DriverManager</code
                  >.
                </p>

                <p>
                  We became aware of this new attack in the exact moment we were
                  building version 46.6.3 (the patch that fixed the “Qing” and
                  “Reginaldo” vulnerabilities).
                </p>

                <p>
                  We released that patch, but also, for good measure, decided to
                  release another point release (46.6.4) that removed H2 as a
                  supported database for analytics. As it was clear that the
                  broader security community was aware of the underlying root
                  causes of the vulnerability, we also <a
                    href="/blog/vulnerability-advisory-h2">put up a blog post</a
                  > and sent out an email advising our customers and OSS users to
                  upgrade, or block all relevant endpoints until they could upgrade.
                </p>

                <p>
                  While all of this was going on, we mitigated the problem on
                  our own servers for Metabase Cloud Customers. As soon as we
                  heard about each exploit, we set up network-level blocks on
                  all relevant API endpoints, closed down our store to new
                  sign-ups, and began the fun process of auditing every scrap of
                  logs we had. By late Saturday night (<strong>July 29th</strong
                  >), we’d individually audited every server that had any calls
                  to the vulnerable endpoints, and we didn’t find any evidence
                  of tampering. We’re still keeping an eye out for any
                  suspicious activity, and are having a lot of internal
                  conversations about what to learn from this.
                </p>

                <p>
                  <strong>On July 31st</strong>, we sent out another tweet and
                  Linkedin post to our community.
                </p>

                <p>
                  All in all, we managed to get almost a week from our
                  obfuscation efforts between when we released our general
                  patched version and when the vulnerability entered general
                  knowledge. Not ideal, but hopefully that gave more people time
                  to upgrade than otherwise would have been able to.
                </p>

                <h2 id="the-current-situation">The current situation</h2>

                <p>
                  <strong
                    >TL;DR: If you are self-hosting and last upgraded before
                    July 28th, 2023, UPGRADE IMMEDIATELY.</strong>
                </p>

                <p>
                  <strong
                    >If you are a Metabase Cloud customer, you are not affected.</strong>
                </p>

                <p>
                  If you are self-hosting and you’re running the latest binaries
                  (46.6.4 at this time), you’re in the clear.
                </p>

                <p>
                  If you’re on a version of Metabase from 43-45, and you have
                  not upgraded to the latest minor versions 43.7.3, 44.7.3,
                  45.4.3 or later YOU ARE VULNERABLE.
                </p>

                <p>
                  If you’re running 42 or below, you are not subject to this
                  vulnerability. But you are exposed to many other security
                  issues and bugs, so we recommend that you upgrade as soon as
                  you can.
                </p>

                <h2 id="what-did-we-learn-from-this-episode">
                  What did we learn from this episode?
                </h2>

                <p>
                  Well, we learned that if you release a patched binary without
                  any information, it takes at most five days for the bytecode
                  to be decompiled, and the underlying vulnerability to be
                  identified and recreated.
                </p>

                <p>
                  We learned that client-supplied connection strings should be
                  treated with more scrutiny, and that JDBC drivers are not to
                  be trusted. We originally were especially paranoid about the <code
                    class="language-plaintext highlighter-rouge"
                    >setup_token</code
                  > being used to create additional admin users, and learned that
                  we should be equally paranoid about anything that opens a database
                  connection.
                </p>

                <p>
                  We did a real run of our logging, incident response, and
                  intrusion-detection processes, and identified areas for
                  improvement.
                </p>

                <p>
                  We’re still doing post-mortems, and will no doubt learn a lot
                  more in the coming days.
                </p>

                <h2 id="appendix">Appendix</h2>

                <ul>
                  <li>
                    <a href="#how-do-i-know-if-i-amwas-affected"
                      >How do I know if I am/was affected</a>
                  </li>
                  <li>
                    <a
                      href="#how-to-know-how-deep-the-attacker-went-and-if-any-information-was-exfiltrated"
                      >How to know how deep the attacker went and if any
                      information was exfiltrated</a>
                  </li>
                  <li>
                    <a
                      href="#how-to-know-if-the-attacker-has-opened-a-reverse-shell"
                      >How to know if the attacker has opened a reverse shell</a>
                  </li>
                  <li>
                    <a href="#what-should-i-do-about-this"
                      >What should I do about this?</a>
                  </li>
                  <li>
                    <a href="#this-vulnerability-is-being-actively-exploited"
                      >This vulnerability is being actively exploited</a>
                  </li>
                </ul>

                <h3 id="how-do-i-know-if-i-amwas-affected">
                  How do I know if I am/was affected
                </h3>

                <p>
                  <strong>If you are a Metabase Cloud customer</strong>, you
                  were not affected in any way that we were able to find. We
                  patched and blocked all vulnerabilities as soon as we got the
                  reports. All instances in our Kubernetes pods have been
                  recycled and recreated from known secure images. We reviewed
                  the logs of all of our clients going back several weeks and
                  haven’t found anything to cause suspicion of exploitation. We
                  will continue to monitor our infrastructure to make sure you
                  are protected.
                </p>

                <p><strong>If you are self-hosting Metabase:</strong></p>

                <p>
                  These vulnerabilities have been present since May 2022, so, in
                  case you saved the logs of your Metabase instance, or you have
                  a load balancer/reverse proxy in front of your Metabase
                  instance, you should check for the following pattern:
                </p>

                <p>
                  If you see on the logs that you received a <code
                    class="language-plaintext highlighter-rouge">POST</code
                  > API call to the <code
                    class="language-plaintext highlighter-rouge"
                    >/api/setup/validate</code
                  > made at any time <em>after</em> the initial setup of your instance
                  that returns either a status <code
                    class="language-plaintext highlighter-rouge">2xx</code
                  > or <code class="language-plaintext highlighter-rouge"
                    >400</code
                  >, and you weren’t on the version we released on July 18th
                  2023, then your instance might have been compromised (as in:
                  your instance <em>might be</em> under the control of an attacker).
                </p>

                <h3
                  id="how-to-know-how-deep-the-attacker-went-and-if-any-information-was-exfiltrated"
                >
                  How to know how deep the attacker went, and if any information
                  was exfiltrated
                </h3>

                <p>There are 2 types of attack:</p>

                <ul>
                  <li>
                    <strong
                      >If you saw a call that returned a status <code
                        class="language-plaintext highlighter-rouge">2xx</code
                      ></strong
                    >, then you won’t be able to see which code the attacker ran
                    on your instance, so you should consider the worst scenario:
                    an attacker got into the server, got the credentials of the
                    application database and was able to connect to it, and they
                    exfiltrated the credentials of your connected data
                    warehouse(s).
                  </li>
                  <li>
                    <strong
                      >If you saw a call that returned a status <code
                        class="language-plaintext highlighter-rouge">400</code
                      ></strong
                    >, then the Metabase logs will print the code that the
                    attacker ran on your instance. E.g.,
                  </li>
                </ul>

                <p>
                  <img
                    src="/images/posts/vulnerability-post-mortem-2023-08-04/logged-code.png"
                    alt="400 status showing the code an attacker could run"
                  />
                </p>

                <p>
                  From this point, the attacker would be able to get the
                  connection string to the Metabase application database, which
                  in turn contains the connection string to your data warehouse.
                </p>

                <h3 id="how-to-know-if-the-attacker-has-opened-a-reverse-shell">
                  How to know if the attacker has opened a reverse shell
                </h3>

                <p>
                  If you run <code class="language-plaintext highlighter-rouge"
                    >top</code
                  > in the server or container running Metabase and see a bash process
                  running with parameters (like <code
                    class="language-plaintext highlighter-rouge">echo</code
                  >, an encoded parameter, etc.), the instance has a reverse
                  shell open (e.g., <code
                    class="language-plaintext highlighter-rouge">PID 3763</code
                  > in the screenshot below).
                </p>

                <p>
                  <img
                    src="/images/posts/vulnerability-post-mortem-2023-08-04/reverse-shell.png"
                    alt="Instance with reverse shell"
                  />
                </p>

                <p>
                  If you run <code class="language-plaintext highlighter-rouge"
                    >netstat -antp</code
                  > in the server or container running Metabase and see active connections
                  for ports that are not the ones that Metabase uses, and the connection
                  has an <code class="language-plaintext highlighter-rouge"
                    >ESTABLISHED</code
                  > state (e.g., the connection from the foreign address <code
                    class="language-plaintext highlighter-rouge"
                    >172.23.0.2:9001</code
                  > in the screenshot below).
                </p>

                <p>
                  <img
                    src="/images/posts/vulnerability-post-mortem-2023-08-04/active-connections.png"
                    alt="Active connections"
                  />
                </p>

                <p>
                  If the shell has been exited for some time, you might also see
                  connections in <code
                    class="language-plaintext highlighter-rouge">FIN_WAIT2</code
                  > status, like in this example
                </p>

                <p>
                  <img
                    src="/images/posts/vulnerability-post-mortem-2023-08-04/wait-status.png"
                    alt="Waiting connections"
                  />
                </p>

                <h3 id="what-should-i-do-about-this">
                  What should I do about this?
                </h3>

                <p>
                  If you suspect you might have been affected, we recommend you:
                </p>

                <ol>
                  <li>
                    Upgrade your instance to the latest binaries, using a fresh
                    server instance.
                  </li>
                  <li>Rotate your data warehouse credentials.</li>
                  <li>
                    Restrict IP access to your data warehouse from unknown
                    hosts.
                  </li>
                  <li>
                    Check that there are no unfamiliar user accounts on your
                    Metabase instance.
                  </li>
                  <li>
                    Rotate your Slack and SMTP credentials tokens used in
                    Metabase.
                  </li>
                </ol>

                <h3 id="this-vulnerability-is-being-actively-exploited">
                  This vulnerability is being actively exploited
                </h3>

                <p>
                  We are aware that some malware developers/botnets have
                  included the code of the exploit in their attacks. We are also
                  aware of at least one instance of attacking Metabase servers
                  to mine cryptocurrency and use the servers as a node for DDoS
                  attacks.
                </p>

                <p>
                  We’re not aware of any other vulnerabilities in the mentioned
                  endpoints.
                </p>
              </div>
              <div class="mt-15">
                <iframe
                  src="../subscribe-to-ai-newsletter-bottom-of-article.html"
                  id="subscribe-to-ai-newsletter-bottom-of-article"
                  class="newsletter-subscribe"
                  onload="javascript:(function(o){
          o.style.height=o.contentWindow.document.getElementById('newsletter-ajax-form-container-below-article').offsetHeight+'px';

          const resizeObserver = new ResizeObserver(function(entries) {
              const $firstEntry = entries[0];
              if ($firstEntry && $firstEntry.borderBoxSize && $firstEntry.borderBoxSize[0]) {
                  const $form = $firstEntry.borderBoxSize[0];
                  if ($form) {
                      o.style.height = $form.blockSize + 'px';
                  }
              }
          });
          resizeObserver.observe(o.contentWindow.document.getElementById('newsletter-ajax-form-container-below-article'));
      }(this));"
                ></iframe>
              </div>
            </div>
          </section>

          <section class="mt-8">
            <div class="d-flex flex-row justify-content-between">
              <h3 class="mb-0">You might also enjoy</h3>
              <a
                class="chevron blue-small-right fw-bold d-none d-lg-flex"
                href="/blog">All posts</a
              >
            </div>
            <div class="row mt-10 mt-lg-13">
              <div class="hover-raise-sm col-xs-12 col-lg-6 mb-8 mb-lg-0">
                <div
                  class="card hover-shadow hover-pointer bg-neutral-white border-0 rounded-3 p-6"
                >
                  <img
                    class="w-100 rounded-2 mb-8"
                    src="/images/posts/metabase-data-stack-survey-2025-blog.jpg"
                    alt="The Metabase Community Data Stack Survey: by data teams, for data teams Image"
                    loading="lazy"
                  />
                  <span class="paragraph-5 neutral-60 mb-3"
                    >May 11, 2025 in <b class="category-name">News</b></span
                  >
                  <h4 class="blog-title mb-4">
                    The Metabase Community Data Stack Survey: by data teams, for
                    data teams
                  </h4>
                  <p class="paragraph-5 mb-6 neutral-40">
                    How the modern data stack is evolving: share yours and see
                    how it compares
                  </p>
                  <div class="d-flex flex-row align-items-center">
                    <img
                      class="circle me-2"
                      src="/images/posts/blog-authors/margaret-rimek.jpg"
                      alt="Margaret Rimek Portrait"
                      width="36"
                      height="36"
                      loading="lazy"
                    />
                    <div class="d-flex flex-column flex-sm-row">
                      <h5 class="neutral-40 mb-0 me-2">Margaret Rimek</h5>

                      <p
                        class="paragraph-5 neutral-60 mb-0 d-none d-sm-block me-2"
                      >
                        ‧
                      </p>
                      <p class="paragraph-5 neutral-60 mb-0">2 min read</p>
                    </div>
                  </div>
                  <a
                    href="/blog/metabase-community-data-stack-survey-2025"
                    class="stretched-link h-0"></a>
                </div>
              </div>

              <div class="hover-raise-sm col-xs-12 col-lg-6 mb-8 mb-lg-0">
                <div
                  class="card hover-shadow hover-pointer bg-neutral-white border-0 rounded-3 p-6"
                >
                  <img
                    class="w-100 rounded-2 mb-8"
                    src="/images/product-hunt-blog-post-image.png"
                    alt="Product Hunt AMA Recap: embedding, open source success, and more Image"
                    loading="lazy"
                  />
                  <span class="paragraph-5 neutral-60 mb-3"
                    >Apr 07, 2025 in <b class="category-name">News</b></span
                  >
                  <h4 class="blog-title mb-4">
                    Product Hunt AMA Recap: embedding, open source success, and
                    more
                  </h4>
                  <p class="paragraph-5 mb-6 neutral-40">
                    Before our launch, I hosted an AMA on ProductHunt and
                    answered questions about Metabase, embeddings, building an
                    open source company, and more.
                  </p>
                  <div class="d-flex flex-row align-items-center">
                    <img
                      class="circle me-2"
                      src="/images/posts/blog-authors/sameer-al-sakran.png"
                      alt="Sameer Al-Sakran Portrait"
                      width="36"
                      height="36"
                      loading="lazy"
                    />
                    <div class="d-flex flex-column flex-sm-row">
                      <h5 class="neutral-40 mb-0 me-2">Sameer Al-Sakran</h5>

                      <p
                        class="paragraph-5 neutral-60 mb-0 d-none d-sm-block me-2"
                      >
                        ‧
                      </p>
                      <p class="paragraph-5 neutral-60 mb-0">8 min read</p>
                    </div>
                  </div>
                  <a
                    href="/blog/metabase-product-hunt-ama"
                    class="stretched-link h-0"></a>
                </div>
              </div>
            </div>
            <a
              class="chevron blue-small-right fw-bold d-flex d-lg-none"
              href="/blog">All posts</a
            >
          </section>

          <div id="right-hand-newsletter-subscribe-widget" class="bleed-right">
            <div class="right-hand-newsletter-subscribe-form-container">
              <h6>Weekly tips for analysts</h6>
              <h5>
                Get actionable insights<br />on AI and data directly to your
                inbox
              </h5>

              <iframe
                src="../subscribe-to-ai-newsletter-righthandside.html"
                id="subscribe-to-ai-newsletter-righthandside"
                onload="javascript:(function(o){
          o.style.height=o.contentWindow.document.getElementById('feedback-widget-newsletter-ajax-form-container').offsetHeight+'px';

          const resizeObserver = new ResizeObserver(function(entries) {
            const $firstEntry = entries[0];
            if ($firstEntry && $firstEntry.borderBoxSize && $firstEntry.borderBoxSize[0]) {
              const $form = $firstEntry.borderBoxSize[0];
              if ($form) {
                o.style.height = $form.blockSize + 'px';
              }
            }

            if (window.resizeLearnRightSidebar) {
              window.resizeLearnRightSidebar();
            }
          });
          resizeObserver.observe(o.contentWindow.document.getElementById('feedback-widget-newsletter-ajax-form-container'));
        }(this));"
              ></iframe>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <div class="bootstrap"></div>
</Base>
